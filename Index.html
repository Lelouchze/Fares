<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ورشة TGD • استقطاب بالأكواد + عجلة</title>
<style>
  :root{--blue:#1e3a8a;--blue-100:#e8eefc;--brown:#8b5e34;--ink:#0f172a;--muted:#64748b;--bg:#f7f8fb;--card:#fff}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{background:linear-gradient(135deg,var(--blue) 0%, #2b4ab6 60%, var(--blue-100) 120%);color:#fff;padding:20px}
  .brand{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .brand h1{margin:0;font-size:20px;font-weight:800}.accent{color:var(--brown)}
  .tag{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);padding:4px 10px;border-radius:999px;font-size:12px}
  .welcome{margin-top:8px;background:#fff1;border-left:4px solid #fff8;padding:8px 12px;border-radius:8px;backdrop-filter:blur(3px)}
  main{max-width:1100px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(16,24,40,.06);padding:16px;margin-bottom:16px}
  .center{text-align:center}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:800;background:var(--blue);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#eaeaea;color:#222}
  .btn.danger{background:#ef4444}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;background:var(--blue-100);color:var(--blue);border:1px solid #c7d2fe;border-radius:999px;padding:4px 10px;font-size:12px}
  .stack{display:flex;flex-direction:column;gap:12px;align-items:center}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:280px}
  .qr{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .qr-box{width:180px;height:180px;border:2px dashed #cbd5e1;border-radius:14px;display:flex;align-items:center;justify-content:center;background:#fff}
  ul{list-style:none;margin:8px 0;padding:0} li{padding:8px 10px;border-bottom:1px dashed #eee}
  canvas{width:100%;max-width:520px;aspect-ratio:1/1;background:#fff;border-radius:50%;display:block;margin:auto;border:8px solid #fff;box-shadow:0 6px 20px rgba(0,0,0,.08)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>أهلاً بكم <span class="accent">بورشة TGD</span></h1>
    <span class="tag">استقطاب بالأكواد (QR) + عجلة اختيار اسم</span>
  </div>
  <div class="welcome">ابدأ أولاً باستقطاب الأسماء عبر QR، ثم انتقل للعجلة بعد انضمام الطلاب.</div>
</header>

<main>
  <!-- صفحة الهبوط -->
  <section id="landingPanel" class="card center">
    <h2>ابدأ الاستقطاب</h2>
    <div class="stack">
      <button id="startCaptureBtn" class="btn">ابدأ استقطاب الأسماء (QR)</button>
      <p class="muted">يتم إنشاء جلسة، عرض QR + رابط، وتجمع الأسماء حيًا.</p>
    </div>
  </section>

  <!-- الاستقطاب -->
  <section id="capturePanel" class="card" style="display:none">
    <div class="row">
      <div class="col">
        <h2>استقطاب الأسماء</h2>
        <div class="stack" style="align-items:flex-start">
          <span id="capSessionCode" class="pill" style="display:none"></span>
          <div class="qr">
            <div class="qr-box" id="capQr"></div>
            <div>
              <div><strong>رابط الانضمام:</strong></div>
              <div id="capJoinLink" style="word-break:break-all;margin:6px 0"></div>
              <div class="muted">الطلبة يمسحوا QR أو يفتحوا الرابط ويكتبوا أسماءهم.</div>
            </div>
          </div>
          <div class="stack" style="align-items:flex-start">
            <button id="gotoWheelBtn" class="btn" disabled>انتقل إلى العجلة</button>
            <button id="capClearBtn" class="btn danger" disabled>حذف الأسماء</button>
          </div>
        </div>
      </div>
      <div class="col">
        <h2>الأسماء الواردة</h2>
        <div class="muted">المسجّلون: <strong id="capCount">0</strong></div>
        <ul id="capNames"></ul>
      </div>
    </div>
  </section>

  <!-- العجلة -->
  <section id="wheelPanel" class="card" style="display:none">
    <div class="row">
      <div class="col center">
        <h2>العجلة</h2>
        <canvas id="wheel" width="520" height="520"></canvas>
        <div class="stack" style="margin-top:10px">
          <button id="spinBtn" class="btn" disabled>دَوِّر العجلة</button>
          <div>
            <button id="removeWinnerBtn" class="btn secondary" disabled>احذف الفائز</button>
            <button id="clearBtn" class="btn danger" disabled>حذف الأسماء</button>
          </div>
          <div id="winnerBox" class="muted"></div>
        </div>
      </div>
      <div class="col">
        <h2>قائمة الأسماء</h2>
        <div class="muted">المسجّلون: <strong id="count">0</strong></div>
        <ul id="namesList"></ul>
      </div>
    </div>
  </section>

  <!-- واجهة الطالب -->
  <section id="joinPanel" class="card" style="display:none">
    <h2>انضمام إلى الجلسة <span id="joinSessionCode" class="pill"></span></h2>
    <label>اكتب اسمك كما تحب أن يظهر على العجلة</label>
    <input type="text" id="studentName" placeholder="مثال: أحمد خالد" />
    <div style="margin-top:10px"><button id="joinBtn" class="btn">إرسال الاسم</button></div>
    <p class="muted" id="joinMsg"></p>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // ــ Config: مشروعك tgdw-c9cb0 ــ
  const firebaseConfig = {
    apiKey: "AIzaSyA7yEAEAsSuNOGDY_GiWgviqJErMeAoWNk",
    authDomain: "tgdw-c9cb0.firebaseapp.com",
    databaseURL: "https://tgdw-c9cb0-default-rtdb.firebaseio.com",
    projectId: "tgdw-c9cb0",
    storageBucket: "tgdw-c9cb0.firebasestorage.app",
    messagingSenderId: "864522007971",
    appId: "1:864522007971:web:c371ff6b264aa3c2309616",
    measurementId: "G-8KCV53VW0F"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch (e) { console.warn("Analytics disabled:", e); }
  const db = getDatabase(app);

  const $=s=>document.querySelector(s);
  const landingPanel=$("#landingPanel"),capturePanel=$("#capturePanel"),wheelPanel=$("#wheelPanel"),joinPanel=$("#joinPanel");
  const capSessionCode=$("#capSessionCode"),capJoinLink=$("#capJoinLink"),capQr=$("#capQr"),capNames=$("#capNames"),capCount=$("#capCount");
  const gotoWheelBtn=$("#gotoWheelBtn"),capClearBtn=$("#capClearBtn");
  const namesList=$("#namesList"),count=$("#count"),wheel=$("#wheel"),ctx=wheel.getContext("2d");
  const spinBtn=$("#spinBtn"),removeWinnerBtn=$("#removeWinnerBtn"),clearBtn=$("#clearBtn"),winnerBox=$("#winnerBox");
  const joinSessionCode=$("#joinSessionCode"),studentName=$("#studentName"),joinBtn=$("#joinBtn"),joinMsg=$("#joinMsg");

  let sessionCode=null,names=[],winner=null,spinning=false,angularVel=0,targetAngle=0,wheelRotation=0;

  const namesRef=c=>ref(db,`sessions/${c}/names`);
  const metaRef=c=>ref(db,`sessions/${c}/meta`);
  const keyFromName=n=>n.trim().toLowerCase().replace(/\s+/g,' ');
  const makeCode=(l=6)=>{
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    return Array.from({length:l},()=> chars[Math.floor(Math.random()*chars.length)]).join('');
  };

  function drawWheel(){
    const W=wheel.width,H=wheel.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-12;
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();ctx.arc(cx,cy,r+10,0,2*Math.PI);ctx.strokeStyle="rgba(139,94,52,.25)";ctx.lineWidth=8;ctx.stroke();
    const n=Math.max(names.length,1),angle=2*Math.PI/n;
    for(let i=0;i<n;i++){
      const s=i*angle+wheelRotation,e=s+angle;
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,s,e);ctx.closePath();
      const tint=i%3===0?'rgba(139,94,52,.18)':'rgba(30,58,138,.18)';
      ctx.fillStyle=`hsl(${(i*360/n)%360},70%,78%)`;ctx.fill();ctx.fillStyle=tint;ctx.fill();
      const mid=(s+e)/2,tx=cx+(r*0.6)*Math.cos(mid),ty=cy+(r*0.6)*Math.sin(mid);
      ctx.save();ctx.translate(tx,ty);ctx.rotate(mid);ctx.fillStyle="#0f172a";ctx.font="15px system-ui";
      ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(names[i]||"—",0,0);ctx.restore();
    }
    ctx.beginPath();ctx.moveTo(cx+r+12,cy);ctx.lineTo(cx+r+42,cy-12);ctx.lineTo(cx+r+42,cy+12);ctx.closePath();ctx.fillStyle="var(--blue)";ctx.fill();
    ctx.beginPath();ctx.arc(cx,cy,34,0,2*Math.PI);ctx.fillStyle="#fff";ctx.fill();ctx.lineWidth=3;ctx.strokeStyle="rgba(139,94,52,.35)";ctx.stroke();
    if(winner){ctx.fillStyle="var(--brown)";ctx.font="bold 16px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("🎉",cx,cy);}
  }
  drawWheel();

  function spin(){
    if(names.length===0||spinning)return;
    const n=names.length,idx=Math.floor(Math.random()*n),anglePer=2*Math.PI/n,segmentCenter=idx*anglePer+anglePer/2;
    targetAngle=(2*Math.PI*(4+Math.floor(Math.random()*2)))+(2*Math.PI-segmentCenter)-(wheelRotation%(2*Math.PI));
    angularVel=(Math.random()*0.25)+0.35;spinning=true;winner=null;winnerBox.textContent="جاري الدوران...";animate();
  }
  function animate(){
    if(!spinning){drawWheel();return;}
    const decel=0.004;wheelRotation+=angularVel;angularVel=Math.max(0.01,angularVel-decel);
    if(angularVel<=0.012){
      spinning=false;wheelRotation+=(targetAngle-(wheelRotation%(2*Math.PI)));
      const n=names.length,anglePer=2*Math.PI/n,at=(2*Math.PI-(wheelRotation%(2*Math.PI)))%(2*Math.PI);
      const idx=Math.floor(((at+anglePer/2)%(2*Math.PI))/anglePer);
      winner=names[idx]||null;drawWheel();winnerBox.innerHTML=winner?`الفائز: <strong>${winner}</strong>`:"";removeWinnerBtn.disabled=!winner;return;
    }
    drawWheel();requestAnimationFrame(animate);
  }

  function bindNamesUI(listEl,countEl,enableBtns){
    return snap=>{
      const obj=snap.val()||{};names=Object.keys(obj).sort((a,b)=>a.localeCompare(b,'ar'));
      listEl.innerHTML=names.map(n=>`<li>${n}</li>`).join("");
      countEl.textContent=names.length;
      if(enableBtns)enableBtns(names.length>0);
      if(!spinning)drawWheel();
    };
  }

  // إنشاء جلسة + عرض QR
  $("#startCaptureBtn").onclick=async()=>{
    try{
      sessionCode=makeCode();
      await set(metaRef(sessionCode),{createdAt:Date.now()});
      const url=new URL(location.href);url.searchParams.set('join',sessionCode);
      capSessionCode.style.display='inline-block';capSessionCode.textContent=`الكود: ${sessionCode}`;
      capJoinLink.textContent=url.toString();capQr.innerHTML="";
      new QRCode(capQr,{text:url.toString(),width:180,height:180});
      onValue(namesRef(sessionCode),bindNamesUI(capNames,capCount,(has)=>{gotoWheelBtn.disabled=!has;capClearBtn.disabled=!has;}));
      landingPanel.style.display='none';capturePanel.style.display='block';
    }catch(err){alert("تعذّر إنشاء الجلسة: "+(err?.message||err));}
  };

  // إلى العجلة
  gotoWheelBtn.onclick=()=>{
    onValue(namesRef(sessionCode),bindNamesUI(namesList,count,(has)=>{spinBtn.disabled=!has;clearBtn.disabled=!has;}));
    capturePanel.style.display='none';wheelPanel.style.display='block';
  };

  // إدارة
  capClearBtn.onclick=async()=>{if(sessionCode)await set(namesRef(sessionCode),null);};
  clearBtn.onclick=async()=>{if(sessionCode)await set(namesRef(sessionCode),null);winner=null;winnerBox.textContent="";removeWinnerBtn.disabled=true;};
  removeWinnerBtn.onclick=async()=>{if(!winner||!sessionCode)return;await remove(ref(db,`sessions/${sessionCode}/names/${keyFromName(winner)}`));winner=null;winnerBox.textContent="";removeWinnerBtn.disabled=true;};
  spinBtn.onclick=spin;

  // واجهة الطالب
  function isJoinPage(){return new URLSearchParams(location.search).has('join');}
  function joinCode(){return new URLSearchParams(location.search).get('join');}
  if(isJoinPage()){
    landingPanel.style.display='none';capturePanel.style.display='none';wheelPanel.style.display='none';joinPanel.style.display='block';
    joinSessionCode.textContent=joinCode();
  }
  joinBtn.onclick=async()=>{
    const code=joinCode(),name=studentName.value.trim();
    if(!name){joinMsg.textContent="رجاءً اكتب اسمك.";return;}
    await set(ref(db,`sessions/${code}/names/${keyFromName(name)}`),true);
    joinMsg.textContent="تم تسجيل اسمك ✔️. يمكنك إغلاق الصفحة.";studentName.value="";
  };

  window.addEventListener('resize',drawWheel);
</script>
</body>
</html>
