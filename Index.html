<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ورشة TGD • أسماء + عجلة (Firebase RTDB)</title>
<style>
  :root{--blue:#1e3a8a;--blue-100:#e8eefc;--brown:#8b5e34;--ink:#0f172a;--muted:#64748b;--bg:#f7f8fb;--card:#fff}
  *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{background:linear-gradient(135deg,var(--blue) 0%, #2b4ab6 60%, var(--blue-100) 120%);color:#fff;padding:20px}
  .brand{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .brand h1{margin:0;font-size:20px;font-weight:800}.accent{color:var(--brown)}
  main{max-width:1000px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(16,24,40,.06);padding:16px;margin-bottom:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}.col{flex:1;min-width:280px}.center{text-align:center}
  label{display:block;margin:6px 0} input[type=text]{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:11px 16px;font-weight:800;background:var(--blue);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}.btn.secondary{background:#eaeaea;color:#222}.btn.danger{background:#ef4444}
  .muted{color:var(--muted);font-size:13px} ul{list-style:none;margin:8px 0;padding:0} li{padding:8px 10px;border-bottom:1px dashed #eee}
  canvas{width:100%;max-width:520px;aspect-ratio:1/1;background:#fff;border-radius:50%;display:block;margin:auto;border:8px solid #fff;box-shadow:0 6px 20px rgba(0,0,0,.08)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>أهلاً بكم <span class="accent">بورشة TGD</span></h1>
    <span class="muted">أدخل اسمك ثم نعمل القرعة 🎯</span>
  </div>
</header>

<main>
  <!-- إدخال الأسماء (أول شاشة) -->
  <section id="inputPanel" class="card">
    <div class="row">
      <div class="col">
        <h2>1) أدخل اسمك</h2>
        <label>اكتب اسمك كما تحب أن يظهر على العجلة</label>
        <input type="text" id="nameInput" placeholder="مثال: أحمد خالد" />
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="addBtn" class="btn">إضافة</button>
          <button id="toWheelBtn" class="btn" disabled>ادخل وضع العجلة</button>
          <button id="clearBtn" class="btn danger" disabled>حذف الأسماء</button>
        </div>
        <p class="muted" style="margin-top:8px">اضغط Enter للإضافة. يمنع التكرار تلقائيًا.</p>
      </div>
      <div class="col">
        <h2>الأسماء</h2>
        <div class="muted">المسجّلون: <strong id="count">0</strong></div>
        <ul id="namesList"></ul>
      </div>
    </div>
  </section>

  <!-- العجلة -->
  <section id="wheelPanel" class="card" style="display:none">
    <div class="row">
      <div class="col center">
        <h2>العجلة</h2>
        <canvas id="wheel" width="520" height="520"></canvas>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
          <button id="spinBtn" class="btn" disabled>دَوِّر العجلة</button>
          <button id="removeWinnerBtn" class="btn secondary" disabled>احذف الفائز</button>
          <button id="backBtn" class="btn secondary">عودة للإدخال</button>
          <button id="wipeBtn" class="btn danger">مسح الكل</button>
        </div>
        <div id="winnerBox" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="col">
        <h2>قائمة الأسماء</h2>
        <div class="muted">المسجّلون: <strong id="count2">0</strong></div>
        <ul id="namesList2"></ul>
      </div>
    </div>
  </section>
</main>

<!-- Firebase v12 (Modules) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { getDatabase, ref, onValue, set, remove, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // === Config: أضفت إعداداتك كما هي ===
  const firebaseConfig = {
    apiKey: "AIzaSyA7yEAEAsSuNOGDY_GiWgviqJErMeAoWNk",
    authDomain: "tgdw-c9cb0.firebaseapp.com",
    databaseURL: "https://tgdw-c9cb0-default-rtdb.firebaseio.com",
    projectId: "tgdw-c9cb0",
    storageBucket: "tgdw-c9cb0.firebasestorage.app",
    messagingSenderId: "864522007971",
    appId: "1:864522007971:web:c371ff6b264aa3c2309616",
    measurementId: "G-8KCV53VW0F"
  };

  // جلسة موحّدة (بدّلها لو حبيت)
  const SESSION_CODE = "TGDW";

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) { console.warn("Analytics disabled (likely non-HTTPS):", e); }
  const db = getDatabase(app);

  // DOM
  const $=s=>document.querySelector(s);
  const inputPanel=$("#inputPanel"), wheelPanel=$("#wheelPanel");
  const nameInput=$("#nameInput"), addBtn=$("#addBtn"), toWheelBtn=$("#toWheelBtn"), clearBtn=$("#clearBtn");
  const namesList=$("#namesList"), countEl=$("#count");
  const namesList2=$("#namesList2"), countEl2=$("#count2");
  const spinBtn=$("#spinBtn"), removeWinnerBtn=$("#removeWinnerBtn"), backBtn=$("#backBtn"), wipeBtn=$("#wipeBtn"), winnerBox=$("#winnerBox");
  const wheelCanvas=$("#wheel"); const ctx=wheelCanvas.getContext("2d");

  // RTDB refs
  const namesRef = ref(db, `sessions/${SESSION_CODE}/names`);
  const metaRef  = ref(db, `sessions/${SESSION_CODE}/meta`);

  // حالة
  let names = []; let winner=null;
  let spinning=false, angularVel=0, targetAngle=0, wheelRotation=0;

  const keyFromName = n => n.trim().toLowerCase().replace(/\s+/g,' ');

  // UI
  function renderLists(){
    const html = names.map(n=>`<li>${n}</li>`).join("");
    namesList.innerHTML = html; namesList2.innerHTML = html;
    countEl.textContent = names.length; countEl2.textContent = names.length;
    const disabled = names.length===0;
    toWheelBtn.disabled = disabled; clearBtn.disabled = disabled; spinBtn.disabled = disabled;
  }

  // Live subscribe
  onValue(namesRef, snap=>{
    const obj = snap.val() || {};
    names = Object.keys(obj).sort((a,b)=>a.localeCompare(b,'ar'));
    renderLists(); if(!spinning) drawWheel();
  });

  // Ensure meta
  update(metaRef, { createdAt: Date.now() }).catch(()=>{});

  // Actions
  async function addName(){
    const v = nameInput.value.trim();
    if(!v) return;
    const k = keyFromName(v);
    try{
      await set(ref(db, `sessions/${SESSION_CODE}/names/${k}`), true);
      nameInput.value = ""; nameInput.focus();
    }catch(err){ alert("تعذّر الإضافة: "+(err?.message||err)); }
  }
  async function wipeAll(){
    try{
      await set(namesRef, null);
      winner=null; winnerBox.textContent=""; removeWinnerBtn.disabled=true;
    }catch(err){ alert("تعذّر المسح: "+(err?.message||err)); }
  }

  addBtn.onclick = addName;
  nameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") addName(); });
  clearBtn.onclick = wipeAll; wipeBtn.onclick = wipeAll;

  toWheelBtn.onclick = ()=>{ inputPanel.style.display="none"; wheelPanel.style.display="block"; drawWheel(); };
  backBtn.onclick    = ()=>{ wheelPanel.style.display="none"; inputPanel.style.display="block"; nameInput.focus(); };

  // Wheel
  function drawWheel(){
    const W=wheelCanvas.width,H=wheelCanvas.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-12;
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();ctx.arc(cx,cy,r+10,0,2*Math.PI);ctx.strokeStyle="rgba(139,94,52,.25)";ctx.lineWidth=8;ctx.stroke();
    const n=Math.max(names.length,1),angle=2*Math.PI/n;
    for(let i=0;i<n;i++){
      const s=i*angle+wheelRotation,e=s+angle;
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,s,e);ctx.closePath();
      const tint=i%3===0?'rgba(139,94,52,.18)':'rgba(30,58,138,.18)';
      ctx.fillStyle=`hsl(${(i*360/n)%360},70%,78%)`;ctx.fill();ctx.fillStyle=tint;ctx.fill();
      const mid=(s+e)/2,tx=cx+(r*0.6)*Math.cos(mid),ty=cy+(r*0.6)*Math.sin(mid);
      ctx.save();ctx.translate(tx,ty);ctx.rotate(mid);ctx.fillStyle="#0f172a";ctx.font="15px system-ui";
      ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(names[i]||"—",0,0);ctx.restore();
    }
    ctx.beginPath();ctx.moveTo(cx+r+12,cy);ctx.lineTo(cx+r+42,cy-12);ctx.lineTo(cx+r+42,cy+12);ctx.closePath();ctx.fillStyle="var(--blue)";ctx.fill();
    ctx.beginPath();ctx.arc(cx,cy,34,0,2*Math.PI);ctx.fillStyle="#fff";ctx.fill();ctx.lineWidth=3;ctx.strokeStyle="rgba(139,94,52,.35)";ctx.stroke();
    if(winner){ctx.fillStyle="var(--brown)";ctx.font="bold 16px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("🎉",cx,cy);}
  }

  function spin(){
    if(names.length===0||spinning)return;
    const n=names.length,idx=Math.floor(Math.random()*n),anglePer=2*Math.PI/n,segmentCenter=idx*anglePer+anglePer/2;
    targetAngle=(2*Math.PI*(4+Math.floor(Math.random()*2)))+(2*Math.PI-segmentCenter)-(wheelRotation%(2*Math.PI));
    angularVel=(Math.random()*0.25)+0.35;spinning=true;winner=null;winnerBox.textContent="جاري الدوران...";animate();
  }
  function animate(){
    if(!spinning){drawWheel();return;}
    const decel=0.004;wheelRotation+=angularVel;angularVel=Math.max(0.01,angularVel-decel);
    if(angularVel<=0.012){
      spinning=false;wheelRotation+=(targetAngle-(wheelRotation%(2*Math.PI)));
      const n=names.length,anglePer=2*Math.PI/n,at=(2*Math.PI-(wheelRotation%(2*Math.PI)))%(2*Math.PI);
      const idx=Math.floor(((at+anglePer/2)%(2*Math.PI))/anglePer);
      winner=names[idx]||null;drawWheel();winnerBox.innerHTML=winner?`الفائز: <strong>${winner}</strong>`:"";removeWinnerBtn.disabled=!winner;return;
    }
    drawWheel();requestAnimationFrame(animate);
  }
  spinBtn.onclick = spin;

  removeWinnerBtn.onclick = async ()=>{
    if(!winner) return;
    const k = keyFromName(winner);
    try{
      await remove(ref(db, `sessions/${SESSION_CODE}/names/${k}`));
      winner=null; winnerBox.textContent=""; removeWinnerBtn.disabled=true;
    }catch(err){ alert("تعذّر الحذف: "+(err?.message||err)); }
  };

  // أول رسم
  drawWheel();
</script>
</body>
</html>
