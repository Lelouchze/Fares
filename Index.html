<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¹Ø¬Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… - ÙˆØ±Ø´Ø© TGD</title>
<style>
  :root{
    --blue:#1e3a8a;    /* Ø£Ø²Ø±Ù‚ Ø¹Ù…ÙŠÙ‚ */
    --blue-100:#e8eefc;/* ØªÙŠÙ†Øª Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
    --brown:#8b5e34;   /* Ø¨Ù†ÙŠ Ø­Ø¯ÙŠØ« */
    --ink:#0f172a;     /* Ù†Øµ Ø¯Ø§ÙƒÙ† */
    --muted:#64748b;   /* Ù†Øµ Ø®Ø§ÙØª */
    --bg:#f7f8fb;      /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø§Ø¦Ù„Ø© */
    --card:#ffffff;    /* Ø¨Ø·Ø§Ù‚Ø© */
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{
    background:linear-gradient(135deg,var(--blue) 0%, #2b4ab6 60%, var(--blue-100) 120%);
    color:#fff;padding:20px
  }
  .brand{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .brand h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.3px}
  .tag{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);padding:4px 10px;border-radius:999px;font-size:12px}
  .welcome{
    margin-top:8px;background:#fff1;border-left:4px solid #fff8;padding:8px 12px;border-radius:8px;backdrop-filter: blur(3px)
  }
  main{max-width:1100px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(16,24,40,.06);padding:16px;margin-bottom:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:290px}
  h2{margin:6px 0 12px;font-size:18px}
  label{display:block;margin:8px 0 4px}
  input[type=text]{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px}
  button{
    cursor:pointer;border:0;border-radius:12px;padding:11px 14px;font-weight:700;
    background:var(--blue);color:#fff;transition:.15s transform ease,.2s opacity ease
  }
  button:hover{transform:translateY(-1px)}
  button.secondary{background:#eaeaea;color:#222}
  button.danger{background:#ef4444}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;background:var(--blue-100);color:var(--blue);border:1px solid #c7d2fe;border-radius:999px;padding:4px 10px;font-size:12px}
  .badge{font-size:12px;background:var(--brown);color:#fff;border-radius:6px;padding:3px 8px}
  canvas{width:100%;max-width:520px;aspect-ratio:1/1;background:#fff;border-radius:50%;display:block;margin:auto;border:8px solid #fff;box-shadow:0 6px 20px rgba(0,0,0,.08)}
  ul{list-style:none;padding:0;margin:8px 0}
  li{padding:8px 10px;border-bottom:1px dashed #eee}
  .qr{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .qr-box{width:170px;height:170px;border:2px dashed #cbd5e1;border-radius:14px;display:flex;align-items:center;justify-content:center;background:#fff}
  .accent{color:var(--brown)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .stat{display:flex;align-items:center;gap:8px}
  .stat-dot{width:8px;height:8px;border-radius:50%;background:var(--blue)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… <span class="accent">Ø¨ÙˆØ±Ø´Ø© TGD</span></h1>
    <span class="tag">Ø¹Ø¬Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… â€¢ QR</span>
  </div>
  <div class="welcome">Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·/Ø§Ù„Ù€QR Ù„ØªØ¯Ø®Ù„ Ø§Ù„Ø³Ø­Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©. Ø§Ù„Ø£Ù„ÙˆØ§Ù†: Ø£Ø²Ø±Ù‚ Ã— Ø¨Ù†ÙŠ Ã— Ø£Ø¨ÙŠØ¶ Ø¨Ø·Ø§Ø¨Ø¹ Ø­Ø¯ÙŠØ«.</div>
</header>

<main>
  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ù‘Ø³ -->
  <div class="card" id="hostPanel">
    <div class="row">
      <div class="col">
        <h2>1) Ø£Ù†Ø´Ø¦ Ø¬Ù„Ø³Ø©</h2>
        <div class="toolbar" style="justify-content:flex-start">
          <button id="createSessionBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <span class="pill" id="sessionCodePill" style="display:none"></span>
        </div>
        <p class="muted" id="hostHint" style="display:none;margin-top:6px">Ø§Ø¹Ø±Ø¶ QR Ø£Ùˆ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø·Ù„Ø§Ø¨.</p>
        <div class="qr" id="joinArea" style="display:none;margin-top:10px">
          <div class="qr-box" id="qrcode"></div>
          <div>
            <div><strong>Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</strong></div>
            <div id="joinLink" style="word-break:break-all;margin:6px 0"></div>
            <div class="muted">Ø§Ù…Ø³Ø­ QR Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…ÙƒØŒ ÙˆØ®Ù„Ø§Øµ âœ¨</div>
          </div>
        </div>
      </div>

      <div class="col" style="text-align:center">
        <h2>2) Ø§Ù„Ø¹Ø¬Ù„Ø©</h2>
        <canvas id="wheel" width="520" height="520"></canvas>
        <div class="toolbar" style="margin-top:10px">
          <button id="spinBtn" disabled>Ø¯ÙÙˆÙÙ‘Ø± Ø§Ù„Ø¹Ø¬Ù„Ø©</button>
          <button id="removeWinnerBtn" class="secondary" disabled>Ø§Ø­Ø°Ù Ø§Ù„ÙØ§Ø¦Ø²</button>
          <button id="clearBtn" class="danger" disabled>Ø­Ø°Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
        </div>
        <div id="winnerBox" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="col">
        <h2>3) Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</h2>
        <div class="stat"><span class="stat-dot"></span> <span class="muted">Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙˆÙ†:</span> <strong id="count">0</strong></div>
        <ul id="namesList"></ul>
      </div>
    </div>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ -->
  <div class="card" id="joinPanel" style="display:none">
    <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø© <span id="joinSessionCode" class="pill"></span></h2>
    <label>Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙƒÙ…Ø§ ØªØ­Ø¨ Ø£Ù† ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¬Ù„Ø©</label>
    <input type="text" id="studentName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯" />
    <div class="toolbar" style="justify-content:flex-start;margin-top:8px">
      <button id="joinBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³Ù…</button>
    </div>
    <p class="muted" id="joinMsg" style="margin-top:6px"></p>
  </div>
</main>

<!-- QRCode (non-module) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Firebase v12 Modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ (Ø£Ø¶ÙØª databaseURL Ù„Ù‚Ø§Ø¹Ø¯Ø© RTDB)
  const firebaseConfig = {
    apiKey: "AIzaSyD7sLHWDkGIZUAB4qNPMaBCq-bR1QMkr7U",
    authDomain: "fares-23426.firebaseapp.com",
    projectId: "fares-23426",
    storageBucket: "fares-23426.firebasestorage.app",
    messagingSenderId: "369109244141",
    appId: "1:369109244141:web:5d6de927469bbcc37494e4",
    measurementId: "G-27E3L0R453",
    databaseURL: "https://fares-23426-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const db = getDatabase(app);

  /* ====== Ø¹Ù†Ø§ØµØ± DOM ====== */
  const $ = s => document.querySelector(s);
  const namesListEl = $("#namesList");
  const countEl = $("#count");
  const wheelCanvas = $("#wheel");
  const ctx = wheelCanvas.getContext("2d");
  let sessionCode = null;
  let names = [];
  let winner = null;

  /* Ø£ÙƒÙˆØ§Ø¯ Ù…Ø³Ø§Ø¹Ø¯Ø© */
  function makeCode(len=6){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s=""; for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }
  function keyFromName(name){
    return name.trim().toLowerCase().replace(/\s+/g,' ');
  }
  const namesRef = code => ref(db, `sessions/${code}/names`);
  const metaRef  = code => ref(db, `sessions/${code}/meta`);

  /* Ø±Ø³Ù… Ø§Ù„Ø¹Ø¬Ù„Ø© */
  let wheelRotation = 0;
  function drawWheel(){
    const W = wheelCanvas.width, H = wheelCanvas.height;
    const cx = W/2, cy = H/2, r = Math.min(W,H)/2 - 12;
    ctx.clearRect(0,0,W,H);

    // Ø¥Ø·Ø§Ø± Ø®Ø§Ø±Ø¬ÙŠ Ø¨Ù†Ù‘ÙŠ Ø®ÙÙŠÙ
    ctx.beginPath(); ctx.arc(cx,cy,r+10,0,2*Math.PI);
    ctx.strokeStyle="rgba(139,94,52,.25)"; ctx.lineWidth=8; ctx.stroke();

    const n = Math.max(names.length, 1);
    const angle = 2*Math.PI / n;

    for(let i=0;i<n;i++){
      const start = i*angle + wheelRotation;
      const end   = start + angle;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,end);
      ctx.closePath();
      // Ø´Ø±Ø§Ø¦Ø­ Ù…ØªØ¯Ø±Ø¬Ø© (Ø£Ø²Ø±Ù‚/Ø¨Ù†ÙŠ/Ø£Ø¨ÙŠØ¶)
      const hue = (i*360/n)%360;
      // Ù†Ø¶Ø¨Ø· Ø§Ù„ØªÙ„ÙˆÙŠÙ† Ù†Ø­Ùˆ Ø§Ù„Ø£Ø²Ø±Ù‚ØŒ Ù…Ø¹ Ù„Ù…Ø³Ø© Ø¨Ù†ÙŠØ© Ø¹Ø¨Ø± Ø§Ù„Ù…Ø²Ø¬
      const mix = i%3===0 ? 'rgba(139,94,52,.15)' : 'rgba(30,58,138,.15)';
      ctx.fillStyle = `hsl(${hue}, 70%, 78%)`;
      ctx.fill();
      // Ø·Ø¨Ù‚Ø© Ø´ÙØ§ÙØ© Ø®ÙÙŠÙØ© Ù„Ø¥Ø­Ø³Ø§Ø³ Ø§Ù„Ø«ÙŠÙ…
      ctx.fillStyle = mix;
      ctx.fill();

      // Ù†Øµ
      const mid = (start+end)/2;
      const tx = cx + (r*0.6)*Math.cos(mid);
      const ty = cy + (r*0.6)*Math.sin(mid);
      ctx.save();
      ctx.translate(tx,ty);
      ctx.rotate(mid);
      ctx.fillStyle="#0f172a";
      ctx.font="15px system-ui, -apple-system, Segoe UI, Arial";
      const label = names[i] || "â€”";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(label,0,0);
      ctx.restore();
    }

    // Ø§Ù„Ù…Ø¤Ø´Ø± (Ù…Ø«Ù„Ø« Ø£Ø²Ø±Ù‚)
    ctx.beginPath();
    ctx.moveTo(cx + r + 12, cy);
    ctx.lineTo(cx + r + 42, cy - 12);
    ctx.lineTo(cx + r + 42, cy + 12);
    ctx.closePath();
    ctx.fillStyle="var(--blue)"; ctx.fill();

    // ÙˆØ³Ø· Ø£Ø¨ÙŠØ¶ Ø¨Ø­ÙˆØ§Ù Ø¨Ù†ÙŠØ©
    ctx.beginPath(); ctx.arc(cx,cy,34,0,2*Math.PI); ctx.fillStyle="#fff"; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle="rgba(139,94,52,.35)"; ctx.stroke();

    if(winner){
      ctx.fillStyle="var(--brown)";
      ctx.font="bold 16px system-ui,-apple-system,Segoe UI,Arial";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText("ğŸ‰", cx, cy);
    }
  }
  drawWheel();

  /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¯ÙˆØ±Ø§Ù† */
  let spinning=false, angularVel=0, targetAngle=0;
  function spin(){
    if(names.length===0 || spinning) return;
    const n = names.length;
    const idx = Math.floor(Math.random() * n);
    const anglePer = 2*Math.PI / n;
    const segmentCenter = idx * anglePer + anglePer/2;
    const laps = 4 + Math.floor(Math.random()*2);
    targetAngle = (2*Math.PI*laps) + (2*Math.PI - segmentCenter) - (wheelRotation % (2*Math.PI));
    angularVel = (Math.random()*0.25)+0.35;
    spinning = true; winner=null;
    $("#winnerBox").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†...";
    animate();
  }
  function animate(){
    if(!spinning){ drawWheel(); return; }
    const decel = 0.004;
    wheelRotation += angularVel;
    angularVel = Math.max(0.01, angularVel - decel);
    if(angularVel <= 0.012){
      spinning = false;
      // Ø§Ø¶Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØªÙ…Ø§Ù…Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù
      wheelRotation += (targetAngle - (wheelRotation % (2*Math.PI)));
      const n = names.length;
      const anglePer = 2*Math.PI / n;
      const at = (2*Math.PI - (wheelRotation % (2*Math.PI))) % (2*Math.PI);
      const idx = Math.floor(((at + anglePer/2) % (2*Math.PI)) / anglePer);
      winner = names[idx] || null;
      drawWheel();
      $("#winnerBox").innerHTML = winner ? `Ø§Ù„ÙØ§Ø¦Ø²: <strong>${winner}</strong>` : "";
      $("#removeWinnerBtn").disabled = !winner;
      return;
    }
    drawWheel();
    requestAnimationFrame(animate);
  }

  /* Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
  let unsub = null;
  function watchNames(code){
    if(unsub) { unsub(); unsub=null; }
    const r = namesRef(code);
    const handler = snap=>{
      const obj = snap.val() || {};
      names = Object.keys(obj).sort((a,b)=>a.localeCompare(b,'ar'));
      namesListEl.innerHTML = names.map(n=>`<li>${n}</li>`).join("");
      countEl.textContent = String(names.length);
      $("#spinBtn").disabled = names.length===0;
      $("#clearBtn").disabled = names.length===0;
      if(!spinning) drawWheel();
    };
    onValue(r, handler);
    unsub = ()=>{ /* Ù„Ø§ Ø¥Ù„ØºØ§Ø¡ Ø³Ù‡Ù„ ÙÙŠ v12 Ù„Ù„Ù€ onValue Ø¥Ù„Ø§ Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø¹Ø¨Ø± ref Ø¬Ø¯ÙŠØ¯Ø› Ù†ÙƒØªÙÙŠ Ø¨Ù‡Ø°Ø§ Ù„Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¨Ø³ÙŠØ· */ };
  }

  /* Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© */
  $("#createSessionBtn").onclick = async ()=>{
    sessionCode = makeCode();
    await set(metaRef(sessionCode), { createdAt: Date.now() });

    watchNames(sessionCode);

    $("#sessionCodePill").style.display='inline-block';
    $("#sessionCodePill").textContent = `Ø§Ù„ÙƒÙˆØ¯: ${sessionCode}`;
    $("#hostHint").style.display='block';
    $("#joinArea").style.display='flex';

    const url = new URL(window.location.href);
    url.searchParams.set('join', sessionCode);
    $("#joinLink").textContent = url.toString();

    const qrDiv = $("#qrcode");
    qrDiv.innerHTML = "";
    new QRCode(qrDiv, { text: url.toString(), width: 170, height: 170 });

    $("#spinBtn").disabled = true;
    $("#clearBtn").disabled = true;
    $("#removeWinnerBtn").disabled = true;
  };

  /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
  $("#spinBtn").onclick = spin;
  $("#removeWinnerBtn").onclick = async ()=>{
    if(!winner || !sessionCode) return;
    await remove(ref(db, `sessions/${sessionCode}/names/${keyFromName(winner)}`));
    winner = null; $("#winnerBox").textContent = "";
    $("#removeWinnerBtn").disabled = true;
  };
  $("#clearBtn").onclick = async ()=>{
    if(!sessionCode) return;
    await set(namesRef(sessionCode), null);
    winner = null; $("#winnerBox").textContent = "";
    $("#removeWinnerBtn").disabled = true;
  };

  /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ */
  function isJoinPage(){ return new URLSearchParams(location.search).has('join'); }
  function joinCode(){ return new URLSearchParams(location.search).get('join'); }

  if(isJoinPage()){
    $("#hostPanel").style.display='none';
    $("#joinPanel").style.display='block';
    $("#joinSessionCode").textContent = joinCode();
  }

  $("#joinBtn").onclick = async ()=>{
    const code = joinCode();
    const name = $("#studentName").value.trim();
    if(!name){ $("#joinMsg").textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ."; return; }
    const k = keyFromName(name);
    await set(ref(db, `sessions/${code}/names/${k}`), true);
    $("#joinMsg").textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù…Ùƒ âœ”ï¸. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©.";
    $("#studentName").value = "";
  };

  window.addEventListener('resize', ()=>drawWheel());
</script>
</body>
</html>
